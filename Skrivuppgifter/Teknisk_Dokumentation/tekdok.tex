\documentclass[a4paper,12pt,fleqn]{article}
\usepackage{fixltx2e}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{sidecap}
\usepackage{fancyhdr}
\usepackage{amssymb,amsmath}
\usepackage[swedish]{babel}
\usepackage[margin=1.5in]{geometry}
\usepackage{abstract}
\usepackage[parfill]{parskip}
\usepackage{tocloft}
\usepackage{adjustbox}
\usepackage{textcomp}
\usepackage[T1]{fontenc}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{tocloft}



% %% Footnotes-Listing %%
\newcommand{\listfootnotesname}{Referenser}% 'List of Footnotes' title 
\newlistof[chapter]{footnotes}{fnt}{\listfootnotesname}% New 'List of...' for footnotes 
\let\oldfootnote\footnote % Save the old \footnote{...} command 
 \renewcommand\footnote[1]{% Redefine the new footnote to also add 'List of Footnote' entries. 
     \refstepcounter{footnotes}% Add and step a reference to the footnote/counter. 
     \oldfootnote{#1}% Make a regular footnote. 
     \addcontentsline{fnt}{footnotes}{\protect 
 \numberline{\thefootnotes}#1}% Add the 'List of...' entry. 
}

\include{pagestyle}

\AtBeginDocument{\addtocontents{toc}{\protect\thispagestyle{empty}}} 

%-------------------------------------------------------------------
%Första sidan
\begin{document}
	\pagestyle{fancy}
\pagenumbering{gobble}
	\thispagestyle{empty}
	\vspace*{\fill}
		\begingroup
			\begin{center}
				\huge{\textbf{Autonom kartritande robot}} 
				\\
				\vspace{15pt}
				\large{\emph{Teknisk dokumentation}}
				\normalsize
				\\
				\vspace{55pt}
				\begin{figure}[htp]
					\begin{center}
				  	  \includegraphics[keepaspectratio=true,scale=1.2]{linkoping.png}  %skala och filnamn.		
					\end{center}
				\end{figure}
				\vspace{40pt}
				MapMaster2001, VT2014
				\\
				Institutionen för systemteknik.
				\\
				Tekniska högskolan vid Linköpings universitet
				\\
				\vspace{20 pt}
				David Habrman \\
				Erik Ekelund \\
				Hans-Filip Elo \\
				Jens Edhammer \\
				Niklas Ericson \\
				Tobias Grundström \\
			\end{center}
		\endgroup
	\vspace*{\fill}

	
	\vspace{2cm}
	\newpage
%-----------------------------------------------------------------
%Projektidentitet
\thispagestyle{empty}
	\vspace*{\fill}
		\begingroup
			\begin{center}
				\LARGE{\textbf{PROJEKTIDENTITET}}
				\\
				\footnotesize
				Grupp 8, 2014/VT, MapMaster2001
				\\
				Tekniska högskolan vid Linköpings universitet, ISY
				\\
				\vspace{1cm}
	  \begin{tabular}{| p{3cm} | p{4.3cm} | p{2.4cm} | p{3.8cm} |}
	    \hline
		\textbf{Namn} & \textbf{Ansvar} & \textbf{Telefon} & \textbf{E-post} \\ \hline
	    Jens Edhammer & Dokumentanvsvarig (DOK) & 076-030 67 80 & jened502@student.liu.se \\ \hline
		Erik Ekelund & Designansvarig (DES) & 073-682 43 06 & eriek984@student.liu.se \\ \hline
		David Habrman &  & 976-017 71 15 & davha227@student.liu.se \\ \hline 
		Tobias Grundström & Testansvarig (TES) & 073-830 44 45 & tobgr602@student.liu.se \\ \hline 
		Hans-Filip Elo &   & 073-385 22 32 & hanel742@student.liu.se \\ \hline 
		Niklas Ericson & Projektledare (PL) & 073-052 27 05 & niker917@student.liu.se \\ \hline
	    \end{tabular}
		
		\vspace{1cm}
		\textbf{E-postlista för hela gruppen:} mapmaster2001@cyd.liu.se
		\\[0.5cm]
		
		\textbf{Kund}: Mattias Krysander, Linköpings Universitet, 581 83  LINKÖPING, \\
		013-28 21 98, matkr@isy.liu.se \\
		\textbf{Kontaktperson hos kund}: Mattias Krysander, 013-28 21 98,matkr@isy.liu.se 
		\\
		\textbf{Kursansvarig}: Tomas Svensson, 3B:528,013 28 21 59,tomass@isy.liu.se
		\\[0.5cm]
		\textbf{Handledare}: Peter Johansson, 013-28 1345 peter.a.johansson@liu.se

				\end{center}
		\endgroup
	\vspace*{\fill}
\newpage

%-----------------------------------------------------------------
%Innehållsföreteckning

\thispagestyle{empty}
\addto\captionsswedish{\renewcommand{\contentsname}{Innehållsförteckning}}

\pagestyle{empty}
\tableofcontents
\cleardoublepage
\newpage
\listoffigures
\newpage

\pagestyle{fancy}

\pagenumbering{arabic}

%-----------------------------------------------------------------
%Översikt

\section{Inledning} 
MapMaster2001 är en robot vars uppgift är att underlätta för nödpersonal vid uppdrag i gasfyllda eller rökfyllda lokaler. MapMaster2001 kan skickas in i ett rum där det finns någon typ av brandhärd, alternativt ett rum med en gasläcka, innan undsättningspersonal skickas in. 

MapMaster2001 kartlägger sin omgivning och skickar sedan information om denna till en persondator som ritar ut en karta på en skärm. MapMaster2001 hittar brandhärden och markerar denna på kartan så att undsättningspersonal enkelt kan släcka elden. 

\subsection{Bakgrund}
Under tredje året på Teknisk fysik och elektroteknik (Y) på Linköpings Universitet utförs ett kandidatarbete
med inriktning fysik eller elektroteknik. Denna rapport behandlar ett kandidatprojekt i elektronik som utförts av sex studenter. Projektgruppen valde att konstruera en kartritande robot på grund av att de flesta såg det som en utmaning både programmeringsmässigt och teorimässigt.

\subsection{Syfte och Mål}
Syftet med detta kandidatarbetet är att konstruera och leverera en fullt autonom robot som ska kunna kartlägga ett begränsat område. Inom området ska RFID-taggar finns utplacerade för att indikera brandhärdar. Roboten i sig ska bestå av tre stycken moduler som ska kunna kommunicera med varandra. Modulerna ska ha olika ansvarsområden för att kunna utföra parallella aktiviteter. 

\newpage
\section{Produkt}

Mapmaster 2001, en autonom kartritande robot med bred funktionalitet, vars syfte är att kunna användas för att lokalisera brandhärdar i rökfyllda rum. Roboten kan autonomt navigera och i realtid rita upp karta av rummet den opererar i. Den markerar även eventuella brandhärdar på kartan så brandmän och annan undsättningspersonal kan få information på förhand om var faran finns. 

Under projeket har en prototyp tagits fram och testats på speciella banor enligt kravspecifikation. Roboten har många kvaliteter och är en bra början för att i en senare version kunna operera i ett mer verkligt scenario som nämns ovan. 
\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,,width=0.4\linewidth]{../Kappa/robot.png}  %skala och filnamn. 
  \end{center}
  \caption{MapMaster2001} %figurtext.
  \label{fig:robot}
\end{figure}

Navigering och positionering är två saker som roboten måste utföra med oerhörd precision. För att kunna åstadkomma detta så har Mapmaster2001 försetts med en rad egenskaper som är listade nedan. MapMaster2001 kan bland annat: 

\begin{itemize}
  \item Kartlägga slutna rum.
  \item Reglera längs väggar.
  \item Läsa av sin omgivning med 5 avståndssensorer.
  \item Mäta sin färdväg med en reflexsensor.
  \item Indikera autonomt/manuellt läge med en lysdiod.
  \item Styras via Bluetooth med hjälp av mjukvara för persondator med ett modernt GUI.
  \item Spara sensordata på persondator och rita upp denna med hjälp av den inbyggda grafritningsfunktionen.
\end{itemize}

All mjukvara tillhörande MapMaster2001 samt dokument finns att hitta på GitHub.\footnote{Källkodsarkiv för MapMaster2001, https://github.com/hansfilipelo/MapMaster2001}

\newpage
\section{Teori}

I den här delen går vi igenom hur implementeringen av de olika delsystemen fungerar och vad som är tanken bakom dem. 

% ------------------- Styrning och kartläggning -----------------------

\subsection{Kartabstraktion}
För att kartlägga behöver en karta abstraheras i mjukvara och agera ramverk åt de beräkningar och beslut som tas utifrån sensordata. MapMaster2001 abstraherar kartan som en matris där objekt sparas, detta löses i form av en C-array med dimensionerna 32x17. Tillgängliga undertyper är:

\begin{itemize}
\item{EmptySection}
\item{UnexploredSection}
\item{Robot}
\item{Closed}
\item{Fire}
\end{itemize}

Robot är en egen klass med polymorfiskt arv från MapSection. 

\paragraph{EmptySection} 
~\\
EmptySection representeras av en tom sektion av kartan. 

\paragraph{UnexploredSection} 
~\\
UnexploredSection representerar en outforskad sektion av kartan. 

\paragraph{Robot} 
~\\
Robot representerar robotens position på kartan. 

\paragraph{Closed} 
~\\
Om en sektion är stängd sätts den till closed.

\paragraph{Fire} 
~\\
Fire representerar en plats där det finns eldhärd, det vill säga en RFID-tagg. 
\newpage

\subsubsection{Styrning och kartläggning}
Positionering och kartläggning sker med hjälp av ett stort antal sensorer och utefter många fördefinierade villkor. När roboten kartlägger utför den vinkelräta svängar för att underlätta positionsskattningen. Algoritmerna som bestämmer traverserad sträcka använder robotens hjulsensor och olika vilkor så som t.ex.  om en rotation utförs och om den främre sensorn ger utslag för att hålla sig exakta. 

\paragraph{Kartläggninsalgoritm}

Kartläggningsalgoritmen är utformad så att roboten börjar med att placera sig så att en vägg går att finna på höger sida. Roboten kommer sedan följa väggen till dess att den kan rita upp ett slutet område att arbeta utifrån, dvs. tills roboten anländt till sin startposition i högerroterat läge. Nästa steg blir att kartlägga områden som ännu ej är kartlagda. Om en köksö upptäcks med medeldistanssensorn kommer roboten åka ut till köksön och sedan se till att rita upp hela köksön innan den går vidare. På detta sätt fortsätter algoritmen till dess att alla delar av rummet är kartlagda dvs. tills hela ytterområdet följts. 

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.8\linewidth]{bilder/Flode_kartritning.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Flödesschema kartläggningsalgoritm} %figurtext.
  \label{fig:map} %glöm inte att uppdatera era labels
\end{figure}

\paragraph{Stänging och slutning av bana}
När roboten har åkt längs högerväggen och återvänder till startkoordinaterna samt har färdriktningen höger i kartabstraktionen anses kartan vara sluten. När kartan är sluten anses fortfarande objekt utanför inramningen att vara outforskade. Då dessa är omöjliga att besöka startas ett anrop till samtliga objekt längs y-axeln på koordinaterna x = 0 och x = 31. Funktionen ber objektet att bli av typen closed om den inte redan är det. Är objektet closed avslutas funktionen där, annars ber den alla sina direkta grannar att även de utföra funktionen. Denna funktion stänger alltså alla objekt i ett område avgränsat av andra closed-objekt.

\paragraph{Avsökning av köksöar}
När roboten sedan slutit hela området börjar den utforska om det finns några så kallade köksöar. Köksöar inom ett avstånd av 120 centimeter detekteras. När en sådan detekteras åker roboten ut till köksön och sluter detta område med hjälp av sina kortdistanssensorer på höger sida. Roboten återvänder sedan till områdets yttervägg tills den hittar en ny köksö. När roboten åkt ett varv återvänder den till utgångspunkten varpå kartläggningen är slutförd. 

För ytterligare fördjupning i SLAM-problemet - se Kappan och dokumentet \textit{''Simultan positionering och kartläggning''}\footnote{Grundström, T. Elo, H-F (2014), \textit{''Simultan positionering och kartläggning''}}.

% ------------------- Reglering -----------------------

\subsection{Reglering}

Roboten kan köras autonomt också manuellt via PC-mjukvara. Då roboten körs autonomt kan den reglera längs en vägg. 

\subsubsection{Reglering av styrning}
Styrmodulen får sensordata skickad till sig från sensormodulen. Detta data används till att reglera riktningen då man följer en vägg.

Den proportionella delen av regleringen reglerar avståndet från sensorerna på robotens högersida jämfört med ett internt referensavstånd. Denna reglering ser till att roboten håller sig inom ett rimligt avstånd till den vägg som följs.

$ u_p = K_{p}*(Ref-fram) $

Där $K_{p}$ är en konstant.

Den andra delen av regleringen baseras på differensen mellan båda sensorerna på högersidan och försöker minimera denna. Detta innebär i praktiken att roboten försöker räta ut sig. Denna typ av reglering medför även en minskad risk att de främre och bakre sensorerna ska ge fel värden genom att slå i en sidovägg.


$ u_d = K_{D}*(fram - bak) $

Den totala styrsignalen ges då av: 

$u = u_d + u_p$

Konstanterna $K_{p}$ och $K_{d}$ kan väljas i mjukvaran för persondator, men de initieras som standard till $K_{p}=5$ och $K_{d}=7$.
%släpp sargen. Den är inte deriverande......

\newpage
%------------------Signalbehandling

\subsection{Filtrering av analoga insignaler}
För att det ska vara möjligt för roboten att utföra sitt uppdrag krävs ett flertal sensorer. Roboten använder sig därför av ett flertal avståndssensorer, ett gyroskop, en reflexsensor och en RFID-läsare. Alla utom RFID-läsaren ger analoga utsignaler. De analoga sensorernas utsignaler A/D-konverteras internt på processorn och kopplas till processorns ADC-pinnar, de pinnar som är kopplade till processorns  interna A/D-omvandlare. Processorn har en intern mux kopplad till ADC-pinnarna som gör det möjligt att välja den aktuella insignalen, alltså vilken pinnes analoga värde som skall avläsas och konverteras. Det digitala värde som kommer från A/D-konverteringen är inte ett avstånd angett i meter eller en vinkelhastiget given i grader per sekund utan värdet är istället en spänningsreferens. Spänningsreferensen kan sedan konverteras till ett avstånd, en vinkelhastighet eller en gråskala (reflexsensorn).

\subsubsection{Avståndssensorer}
Roboten använder sig av två olika typer av sensorer, mellandistans (20-150 cm) och kortdistans (10-80 cm). Avståndssensorerna är dock uppbyggda på samma sätt och ger en analog spänningsreferens. Spänningsreferensen A/D-omvandlas och måste sedan konverteras till ett avstånd. För att göra detta togs två olika formler, en för varje typ av avståndssensor, fram med hjälp av MATLAB:s curve fit toolbox. Formlerna togs fram genom att notera vilken spänningsreferens som representerade vilket avstånd, plotta avstånd mot spänning och slutligen användes MATLAB för att skapa en fjärdegradskurva som bäst interpolerar de uppmätta talparen.

\subsubsection{Reflexsensor}
För att beräkna den sträcka som roboten kör så används en reflexsensor. På ett av robotens hjul tejpades en papparsskiva fast. Skivan består av tolv cirkelsektorer, varannan vit och varannan svart. Vid varje avläsning ger reflexsensorn en utsignal beroende på gråskalan hos den belysta ytan, mörkare avläsningsyta ger en högre utsignal och ljusare ger en lägre. Ett tröskelvärde införs och sedan räknas varje gång den A/D-omvandlade signalen skiftar sida om tröskelvärdet. Genom att multiplicera räknaren med hjulets omkrets delat på tolv så kan den tillryggalagda sträckan per cirkelsektor beräknas.

\subsubsection{Gyroskop}
Gyroskopet ger en spänningsreferens som representerar vinkelhastighet. Dess A/D-omvandlade referens omvandlas dock inte till vinkelhastighet. Vi utnyttjar istället den digitala spänningsreferensen och adderar respektive subtraherar den från en tänkt vinkel med jämna mellanrum. Då intervallen mellan varje läsning är lika vet vi att en perfekt 90-graderssväng representeras av en ren summa utan skalning med tid. För att ta fram summan utfördes en enkel kalibrering genom att ett flertal gånger snurra roboten 90 grader och se vad summan blev. Då gyrot ej sitter perfekt centrerat krävs olika gränser för rotation moturs resp. medurs. 


\newpage
%-----------------Kommunikation
\subsection{Kommunikation}
Eftersom roboten byggs och styrs med tre moduler med en processor var krävs kommunikation mellan processorerna, denna utförs med en buss. Bussen som används är en SPI-buss.
För att kunna få kartan ritad på en PC krävs trådlös kommunikation mellan robot och PC.

\subsubsection{Trådlös kommunikation}
För den trådlösa kommunikationen med roboten används Bluetooth. En kortare undersökning angående olika typer av trådlös kommunikation finns att tillgå i fördjupningsuppgiften \emph{''Trådlös Kommunikation''}\footnote{Ericson, N. Edhammer, J. (2014), \textit{''Trådlös kommunikation''}} som kan hittas i Kappan - Appendix A
Kommunikationen över Bluetooth utförs av Firefly-Bluesmirf Gold (FBG), figur~\ref{fig:firefly}, ett modem som parkopplas mot en persondator.
FBG skickar information till persondator via protokollet RS232\footnote{\url{https://docs.isy.liu.se/twiki/bin/view/VanHeden/RS232}}. 
Se appendix Scheman för schema över anslutning av TxD och RxD, vilka sköter sändning och mottagning av data.
När data skickas till processorn så är detta avbrottshanterat. I avbrottet utnyttjas en databuffer vid namn inDataArray som sedan kopieras till bufferten pcHandle i datahanteringen av Bluetooth. Även Bluetooth datahanteras utanför avbrotten precis som SPI-kommunikationen.

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.4\textwidth]{bilder/robotbilder/Firefly.jpg}  %skala och filnamn. 
  \end{center}
  \caption{FireFly-BlueSmirf Gold monterad på roboten} %figurtext.
  \label{fig:firefly}
\end{figure}


\paragraph{Sändning av kartan}
För att undvika problem vid mottagning av kartan på PC sidan skickas en rad i taget med hjälp av en timer. Main-loopen på kommunikationsmodulen kollar en gång per huvud-loop om det är okej att skicka en rad. När timern genererar ett avbrott sätts en flagga att ytterligare en rad är redo att skickas. När samtliga rader har skickats över sätts flaggan som avgör om kartrader ska skickas över till \emph{false}.
\newpage
\subsection{Kommunikationsmodulens huvudloop}

Huvudloopen på kommunikationsmodulen kollar ett antal sanningsvariabler för att avgöra om ny data finns tillgänglig för datahantering. För flödet, se figur~\ref{fig:mainmaster}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.8\textwidth]{bilder/mainmaster.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Kommunikationsmodulens huvudloop} %figurtext.
  \label{fig:mainmaster}
\end{figure}



\subsubsection{Mastermodulens mottagning över buss}

Mastermodulen hämtar data från en slave när den signalerar att data finns redo genom ett av avbrotten INT0 eller INT1. Där INT0 tillhör sensormodulen och INT1 tillhör styrmodulen. Datahantering sker utanför avbrotten genom att sanningsvariabler sätts i avbrotten efter färdig mottagning av data.
Slave skickar som första data längden på överföringen. Det är denna som gör att vi kan säga när mottagningen är klar. Hela metoden kan utläsas ur flödesschemat i figur~\ref{fig:spimaster}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.4\textwidth]{bilder/masterinterrupt.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Mottagning av data från slave} %figurtext.
  \label{fig:spimaster}
\end{figure}


\subsubsection{Slavemodulers mottagning över buss}
När mastermodulen initierar SPI-kommunikationen med en slave dras SlaveSelect-signalen för den givna processorn låg för att generera ett SPI-avbrott på sagda slave. När slave har tagit emot det antal bytes som specificeras av första byten i paketet genereras ett internt avbrott med hjälp av PCint16. I detta nya avbrott hanteras datan från transmissionen. En övergripande struktur angående mottagningen av SPI-trafik kan ses i flödesdiagrammet i figur~\ref{fig:spislave}.

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.4\textwidth]{bilder/spislaverec.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Översiktsbild av mottagning för en SPI-slav} %figurtext.
  \label{fig:spislave}
\end{figure}

\subsubsection{Busstrafik}
På bussen kommer ett antal olika typer av kommandon att skickas. Dessa förklaras i paragraferna nedan. 
Tyngre och snabbt på varandra följande transmissioner kan leda till låsningar av bussen i form av att till exempel sensordata slutar levereras till Bluetoothmodulen eller att ett kommando missas. Därför hanteras de tyngsta transmissionerna med en konfirmationsstruktur.
De tyngsta kommandona utförs endast på icke-kritiska tillfällen i respektive slave-modul.

\paragraph{Styrkommandon från PC}
~\\
När styrkommandona skickas från PC, kommer kommunikationsmodulen skicka datan vidare till styrmodulen som utför kommandot.
\paragraph{Konverterat sensor-data}
~\\
Sensor-data kommer att behandlas i sensormodulen och därefter kommer modulen att skicka ett avbrott till master om att data finns tillgängligt. Mastern svarar och startar bussöverföringen.
\paragraph{Kartabstraktion så styrenheten kan välja färdväg}
~\\
Kartabstraktionen och robotens position kommer att uppdateras allt eftersom ny sensordata kommer in. Efter att ny sensordata har mottagits av master skickar mastern ut sensordata till styrenheten.
\paragraph{Kommandon för inställning av reglerparametrar.}
~\\
Kommandon tas emot med hjälp av Bluetooth på mastern från PC. Mastern skickar detta vidare till styrenheten. 
\paragraph{RFID aktivering och bekräftelse}
~\\
Kommandot skickas från styrmodulen via mastern som speglar ner kommandot till sensormodulen. Sensormodulen startar då RFID-läsning och skickar bekräftelse till styrmodulen när RFID-kortet är detekterat.  

\paragraph{Aktivering av gyro och bekräftelse}
~\\
Kommandot skickas från styrmodulen via mastern som speglar ner kommandot till sensormodulen. Sensormodulen startar då en Gyro-omvandling och skickar bekräftelse till styrmodulen när roboten har roterat 90 grader. 

\paragraph{Aktivering av hjulsensor och bekräftelse}
~\\
Kommandot skickas från styrmodulen via mastern som speglar ner kommandot till sensormodulen. Sensormodulen startar då en mätning på hjulsensorn och skickar en bekräftelse till styrmodulen när roboten har färdats 40 cm. 




%-----------------------------------------------------------------
%Systemet
\newpage
\section{System}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/overview}  %skala och filnamn. 
  \end{center}
  \caption{Översiktsbild av systemet} %figurtext.
  \label{fig:overview}
\end{figure}

Roboten består av tre delsystem, en kommunikationsmodul, en sensormodul och en styrmodul. Utöver dessa tre moduler finns en buss mellan dem som sköter kommunikation, ett chassi samt en tillhörande mjukvara för persondator. Sensormodulen hanterar analoga sensorsignaler och omvandlar dessa till användbara mätdata som skickas vidare till kommunikationsmodulen och styrmodulen. 
Kommunikationsenheten agerar buss-master och sköter all kommunikation mellan de andra enheterna. Kommunikationsmodulen sköter även kommunikationen mellan PC och roboten via en Bluetooth-adapter. Styrenheten sköter robotens fyra drivande motorer, kartläggning och positionsskattning samt tar beslut om körriktning vid autonom operation. 
De tre delsystemen kommunicerar via en SPI-buss med ett eget specificerat protokoll och är byggda runt processorerna ATMEL Atmega 1284p med 16KByte SRAM. 
\newpage

Chassit har fyra DC-motorer, placerade längst fram och längst bak på sidorna av chassit. Motorerna är stelmonterade i chassit vilket betyder att rotation utförs genom att en differens i rotationshastighet införs mellan motorparen. Rotationer görs alltid med vinkelräta svängar. De utförs med hjälp av gyrot som är placerat på sensormodulen. 

Sensorerna som tillhör sensormodulen, förutom robotens RFID-läsare, är placerade på ett sådant sätt att sensorer interfererar minimalt med varandra. På höger sida av roboten har två stycken kortdistanssensorer placerats för att ge indata till robotens PD-reglering. På vänster sida sitter en medeldistanssensor som används för att upptäcka sidokorridorer, öppna ytor och så kallade öar, slutna konstruktioner som inte tillhör ytterväggen. Under roboten sitter en RFID-läsare. Vid upptäckt av RFID-tagg skickar den en signal över USART innehållande taggens ID-nummer till sensormodulen. Sensormodulen skickar sedan denna upptäckt vidare till de andra modulerna.

\subsection{Programmering av robot}
Robotens mjukvara, dels bifogad till detta dokument samt dels tillgänglig på Github\footnote{Källkodsarkiv för MapMaster2001, \url{https://github.com/hansfilipelo/MapMaster2001}}, programmeras via Atmel Studio. Efter uppkoppling behöver robotens tre delsystem programmeras individuellt. 

\subsection{Kommunikation via buss}
En buss som kommunicerar över protokollet SPI sköter kommunikationen mellan robotens tre delsystem. SPI-protokollet är ett kommunikationsprotokoll med full-duplex som fungerar genom att byta åtta lokala bitar med 8 bitar från modulen den kommunicerar med. 

I mjukvarulagret av bussen används ett egenimplementerat protokoll för både transmissioner över Bluetooth och SPI. Protokollet är konstruerat så att den första byten definierar längden på meddelandet som skickats. Nästföljande två bytes definierar kommandotyp och argument till den typen, t.ex. Sensordata från sensor 1, A1.
Efter de tre första bytes följer godtyckligt lång datamängd se figur 3. 

Specificerat bussprotokoll är enbart halv-duplex, dvs. data kan enbart skickas i en riktning åt gången, hela kapaciteten hos SPI utnyttjas därmed inte. 

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,scale=0.6]{bilder/Bussprotokoll.png}  %skala och filnamn. 
  \end{center}
  \caption{Översiktsbild av kommunikationsprotokollet} %figurtext.
  \label{fig:bussprotocol}
\end{figure}

\newpage
Bussens tillgängliga kommandon är:

\begin{tabular}{| p{0.20\textwidth} | p{0.15\textwidth} | p{0.1\textwidth} | p{0.12\textwidth} | p{0.33\textwidth} |}
	\hline
	\rowcolor{listinggray}
	\textbf{Funktion} & \textbf{Datalängd} & \textbf{Kodord} & \textbf{Argument} & \textbf{Datastruktur} \\ \hline
	Rotera vänster & 3 & r & 0 & Hastighet (0-100) \\ \hline
	Rotera höger & 3 & r & 1 & Hastighet (0-100) \\ \hline
	halt & 1 & h & DNC & DNC \\ \hline
	Kör framåt & 3 & f & DNC & Hastighet (0-100) \\ \hline
	Kör bakåt & 3 & b & DNC & Hastighet (0-100) \\ \hline
	Aktivera autonomt läge & 1 & a & DNC & DNC \\ \hline
	Aktivera manuellt läge & 1 & q & DNC & DNC \\ \hline
	Säg åt styrmodul att skicka karta & 1 & F & DNC & DNC \\ \hline
	Sätt variabler för reglering & 11 & P & 0 & Kp(10-tal, 1-tal, 10-del, 100-del), Kd(10-tal, 1-tal, 10-del, 100-del), Referensavstånd \\ \hline
	Sensordata & 26 & S & DNC & Sensor0(100-tal, 10-tal, 1-tal), Sensor2... , Sensor6(100-tal, 10-tal, 1-tal) \\ \hline
	Kalibrera gyro & 2 & g & 0 & DNC \\ \hline
	Börja mäta med gyro & 2 & g & 1 & DNC \\ \hline
	Svängt 90 grader & 1 & G & DNC & DNC \\ \hline
	RFID detekterad & 1 & R & DNC & DNC \\ \hline
	Tillåt RFID-avläsning & 1 & r & DNC & DNC \\ \hline
	En rad av kartan & 19 & M & Radnr & Chars (u, c, e eller f) \\ \hline
	Konfirmering av mottagen kartrad & 2 & m & Radnr & DNC \\ \hline
\end{tabular}
~\\
Där DNC står för ''Do not care''.
\newpage
% ----------------------------- Kommunikationsmodul ------------------------------
% --------------------------------------------------------------------------------


\section{Kommunikationsmodul}
Modulen hanterar kommunikation mellan robotens olika delar samt med persondatorn via Bluetooth. Kommunikationsmodulen som syns i figur~\ref{fig:robot}, kommer att agera master på robotens interna buss. Detta betyder att allt datautbyte som sker mellan moduler initieras av kommunikationsmodulen. 
Vid kommunikation mellan övriga moduler, d v s mellan sensor- och styrmodul, kommer denna information först gå via kommunikationsmodulen för att sedan skickas vidare.
Kommunikationsmodulen är även ansvarig för transmission av sensordata och manuella styrkommandon mellan roboten och PC-mjukvaran.

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/kom_overview.png}  %skala och filnamn. 
  \end{center}
  \caption{Översiktsbild av kommunikationsdelen av systemet} %figurtext.
  \label{fig:overviewKom}
\end{figure}
\newpage
\subsection{Kommunikationsfall}
Ett par exempel på kom\-mun\-ikations\-fall.

Kommunikationsmodulen skickar data mellan de olika enheterna. Ett par olika kommunikationsfall demonstreras i flödesdiagram i Appendix B.

Fall 1: Kommunikationsmodulen skickar manuella styrkommandon till styrmodulen, se figur~\ref{fig:case1flow}.

Fall 2: Sensormodulen signalerar att ny sensor-data är redo, se  figur~\ref{fig:case2flow}.

Fall 3: Kartdata skickas från kommunikationsmodulen till PC, se figur~\ref{fig:case3flow}. 
 
\subsection{Komponenter}
Komponenterna är numrerade och finns att hitta i kretsschemat, se figur~\ref{fig:kopplingstyr}
\begin{enumerate}
  \item AVR processor av typen ATMega1284
  \item Bluetooth-dongel, Firefly, BlueSmirf Gold
  \item LCD-Display
  \item Resetknapp
  \item Manuell/Autonom knapp
  \item Kristalloscillator EXO-3, 14.745 MHz
  \item Lysdiod
\end{enumerate}



\subsection{Buss}
Mellan processorerna används SPI som bussprotokoll. Kommunikationsmodulen agerar master medan styr- och sensormodul agerar slaves. Kommunikation kommer alltid att initieras av master och om slave vill skicka data, genererar de ett avbrott på master som talar om att de har data som är redo att skickas. Bussen använder följande kopplingar:
\begin{itemize}
	\item MISO - Master Input Slave Output, data till master.
	\item MOSI - Master Output Slave Input, data till slave.
	\item SLAVEINT0 - Avbrott från slave 0.
	\item SLAVEINT1 - Avbrott från slave 1.
	\item SLAVESELECT0 - Väljer denna processor som aktiv slav.
	\item SLAVESELECT1 - Väljer denna processor som aktiv slav.
	\item SCK - Serial Clock, klocka från master.
\end{itemize}


\subsection{LCD-Display}
Sensordata och annan information från roboten visas på en alfanumerisk-display, närmare bestämt LCD JM162A. Displayen används för att visa sensordata samt eventuella parametrar för debugging under tester. Displayen är ansluten till processorn enligt kretschemat i appendix A. 
Vid varje uppstart initieras LCD-displayen enligt nedanstående flödesschema. Varje steg startas med att processorn skickar ett kommando till ingångarna på LCD-displayen. Kommandon finns specificerade i databladet\footnote{Datablad för JMA162, https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/jm162a.pdf, hämtad 2014-05-23}. Skrivning till displayen tar tid och för att inte låsa ner mastermodulen helt har ett buffersystem implementerats. Buffern håller koll på vilken rad och kolumn som för tillfället ska skrivas ut och kan därför avsluta skrivningen direkt efter att ingen eller en karaktär är utskriven på displayen. Därefter kan mastern återgå till main-loopen för att hantera inkommande eller mottagande data. Genom att hantera skrivningar på detta vis undviker vi att låsa kommunikationsmodulen vid de tidskrävande LCD-skrivningarna.

\subsubsection{Uppstart}
	
Vid uppstart av systemet kommer LCD-displayen att initieras enligt flödes\-schemat i figur~\ref{fig:flowlcdstart}

\begin{itemize}
  \item Power ON - sätter på strömförsörjningen
  \item Function set - Sätter överförsdatalängden till 8 bitar och displayläget till 2-rader.
  \item Display ON - slår på displayen och slår på markören. 
  \item Entry mode set - sätter markörens riktning vid skrivning
  \item End - Slut på initieringen
\end{itemize}

\begin{figure}[htp]
	  \begin{center}
	  \includegraphics[keepaspectratio=true,width=0.4\linewidth]{bilder/startup}  %skala och filnamn. 
	  \end{center}
	  \caption{Uppstart av LCD-display} %figurtext.
	  \label{fig:flowlcdstart}
	\end{figure}

\newpage


\subsubsection{Skrivning}

Skrivning till LCD-displayen kommer ske enligt flödesschemat i figur~\ref{fig:flowlcdwrite}
\begin{itemize}
  \item Start write procedure - Startar skrivning till LCD-displayen
  \item Clear - Rensar hela displayen
  \item Set DDRAM - gör DDRAMet tillgängligt
  \item Write data to RAM - Skrivning av data in till RAM ifrån DDRAM
\end{itemize}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.5\linewidth]{bilder/write}  %skala och filnamn. 
  \end{center}
  \caption{Skrivning till LCD-display} %figurtext.
  \label{fig:flowlcdwrite}
\end{figure}


\subsection{Switchar}
En switch styr om roboten exekverar programkod för autonom styrning eller manuell styrning. Denna switch kan även byta läge via ett virtuellt kommando från PC. Ett avbrott signalerar till processorn att den ska byta programkod, avbrottet ligger på PIN16 (INT0) se appendix A. Av/På-knappen styr strömförsörjningen till samtliga moduler. 

\subsection{Konstruktion}
Kommunikationsmodulen är monterad på ett separat virkort och bussledningarna kopplas till en bandkabel för sammankoppling med det andra virkortet.  Bandkabeln förser även virkortet med spänning.
Bluetooth-modemet kopplas in i en av de redan existerande socklarna på virkortet. Även för JTAG på kommunikationsmodulen utnyttjas en redan existerande sockel. LCD-Displayen samt switch-knappen placeras på kortet och viras fast. Resetknappen är konstruerad med ett pull-up motstånd för detaljerad information se kopplingsschema i figur~\ref{fig:kopplingkom}.
Utöver detta kopplas även en extern klocka in, i form av en kristalloscillator.

% ----------------------------- Styrmodul ----------------------------------------
% --------------------------------------------------------------------------------

\newpage
\section{Styrmodul}
Styrmodulen kontrollerar styrningen hos roboten, och gör även beräkningar för kartläggning och positionering. 

Styrmodulens (slave) huvudkomponent består av en AVR-processor, Atmel ATmega1284p som får instruktioner från kommunikationsmodulen (master) via bussen. Styrmodulen kommunicerar även med drivkretsen på chassit. Chassit är av typen Terminator som drivs av en NiMH- eller NiCd-ackumulator på 7.2V. Det har även fyra stycken växlade DC-motorer som är kopplade till var sitt drivhjul. 

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/styrmodul}  %skala och filnamn. 
  \end{center}
  \caption{Översikt styrmodul} %figurtext.
  \label{fig:styr} %glöm inte att uppdatera era labels
\end{figure}
\newpage

% ----------- Komponenter ------------------

\subsection{Komponenter}
Komponenterna är numrerade och finns att hitta i kretsschemat, se kopplingsschema styrmodul~\ref{fig:kopplingstyr}.
\begin{enumerate}
	\item Systemchip - Atmel ATmega1284p (1)
	\item Resetknapp (2)
	\item Chassi
	\item Batteri, 7.2 V
\end{enumerate}
\subsection{Signaler}
Motorerna styrs parvis med två signaler per sida:
\begin{itemize}
	\item DIRL - Styr den vänstra motorns rotationsriktning
	\item DIRR - Styr den högra motorns rotationsriktning
	\item PWML - Pulsbreddmodulerad signal som styr den vänstra motorns hastighet
	\item PWMR - Pulsbreddmodulerad signal som styr den högra motorns hastighet.
\end{itemize}
~\\
Dessa är kopplade direkt från processorn till chassits drivkrets enligt bild.
Styrmodulen är ansluten till bussen med hjälp av MISO- och MOSI-pinnarna.

\begin{itemize}
	\item MISO - Master Input Slave Output, data skickas till master
	\item MOSI - Master Output Slave Input, data skickas till slave
	\item MASTERINT - Skickar avbrott till master
	\item SLAVESELECT - Väljer denna processor som aktiv slav
	\item SCK - Serial Clock, klocka från master
\end{itemize}
~\\
Utöver detta är en tryckknapp ansluten till RESET för att förenkla felsökning och uppstart. 

\newpage
\subsection{Konstruktion}

Vid konstruktion av styrmodulen används chassit som grund. Till chassit kopplas batteriet med den medföljande strömkabeln. Systemchippet placeras tillsammans med resetknappen och en sockel för JTAG, som används vid programmering av modulen, på ett virkort. Utöver detta kopplas även en extern klocka in, i form av en kristalloscillator. Signalerna för bussen kopplas till en egen sockel för att underlätta användning av bandkabel mellan moduler, bandkabel syns i figur\ref{fig:band}. För fullständigt kopplingsschema till styrmodulen, se Appendix. 

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.5\linewidth]{bilder/robotbilder/Bandkabel.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Bandkabel mellan virkorten} %figurtext.
  \label{fig:band}
\end{figure}

\newpage


% ----------------------------- Sensormodul --------------------------------------
% --------------------------------------------------------------------------------

\section{Sensormodul}
Sensormodulens uppgift är att A/D-omvandla signaler från robotens avståndssensorer, reflexsensor och gyro för att sedan skicka detta vidare till kommunikationsmodulen i ett hanterbart format. Den har även som uppgift att via en RFID-läsare detektera brandhärdar som i detta fall representeras av RFID-taggar. I figur~\ref{fig:sensorflow} beskrivs hanteringen av sensordata. Sensormomdulen är byggd kring AVR-processorn ATMEL 1284p. En överblick av systemet visas i figur~\ref{fig:sensoroverview}.

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/overblicksensor}  %skala och filnamn. 
  \end{center}
  \caption{Överblick av sensormodulen} %figurtext.
  \label{fig:sensoroverview}
\end{figure}

\subsection{Kopplingsschema}

För en beskrivande bild av kopplingsschemat se appendix A.

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.5\textwidth]{../Kappa/reflexsensor.png}  %skala och filnamn. 
  \end{center}
  \caption{Reflexsensor} %figurtext.
  \label{fig:reflex} %glöm inte att uppdatera era labels
\end{figure}

Port A används som en A/D-omvandlare då denna har en inbyggd A/D-omvandlare. PIN 39 kopplas till en reflexsensor, se figur \ref{fig:reflex}, SFH300, PIN 35-38 kopplas till avståndssensorer för kortdistans, GP\-2Y\-0A\-21\-YK, 
PIN 34 kopplas till en avståndssensor för mellandistans, GP2Y0A02YK, och PIN 35 kopplas till ett gyro för vinkelhastighetsmätning, ML\-X9\-06\-09. Port B används för busskommunikation. PIN 3 skickar avbrott till master, PIN 5 används till slave select master, PIN 6 tar emot data från bussen, PIN7 skickar data till bussen och till PIN 8 kopplas klockan från master. Till port C PIN 23 kopplas en RFID-läsare, Parallax-Reader. Port D används inte i denna modul. 

PIN 31 och 11 kopplas till jord, PIN 13 kopplas till klocka från master, PIN 12 används inte i denna modul, PIN 9 kopplas till en avstudsad manuell switch, en reset-knapp, PIN 32 kopplas till en spänningskälla på 5 V som används som referensspänning, PIN 10 kopplas också den till en spänningskälla på 5 V och PIN 30 kopplas genom ett LP-filter till samma externa spänningskälla.

Alla sensorsignaler utom de från RFID-läsaren passerar först genom ett lågpassfilter (LP-filter) var och ett bestående av ett motstånd på 18k$\Omega$, samt en kondensator med en kapacitans på 100nF. Se figur \ref{fig:lpfilter}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.3\linewidth]{bilder/lp-filter2}  %skala och filnamn. 
  \end{center}
  \caption{Lågpassfilter} %figurtext.
  \label{fig:lpfilter}
\end{figure}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.8\linewidth]{bilder/sensorflode}  %skala och filnamn. 
  \end{center}
  \caption{Flödesdiagram för sensorhantering} %figurtext.
  \label{fig:sensorflow}
\end{figure}

\subsection{Komponenter}
Komponenterna är numrerade och finns att hitta i kopplingsschemat för sensormodulen ~\ref{fig:kopplingsensor}.
\begin{enumerate}
	\item Reflexsensor - SFH300
	\item Avståndssensor för längre avstånd - GP\-2Y3A\-00\-3K\-0F
	\item 4 st avståndssensorer för kortare avstånd - GP\-2Y\-0A\-21\-YK
	\item Avståndssensor för mellan avstånd - GP2Y0A02YK
	\item Vinkelhastighetssensor - MLX\-90\-609
	\item RFID-sensor - Par\-all\-ax-Read\-er\
	\item Systemchip - Atmel ATmega1284p
\end{enumerate}
~\\

\subsubsection{Systemchip}
Modulen är byggd kring processorn Atmel ATmega1284p\footnote{Datablad för ATmega1284p, \url{http://www.atmel.com/ja/jp/Images/doc8059.pdf}, hämtad 2014-05-23}. Processorn hämtar kontinuerligt data från alla sensorer via processorns inbyggda A/D-omvandlare med tillhörande mux. Denna är programmerbar och innehåller de program som behövs för att konvertera signalerna till avstånd, tillryggalagd sträcka, svängar och upptäckta RFID-taggar. Sensormodulen bildar ett medelvärde, beräknat från 30 mätningar, från varje avståndssensor och skickar det kontinuerligt till kommunikationsmodulen, via en SPI-buss.


\subsubsection{RFID-sensor}
För att kunna detektera RFID-taggen så krävs en RFID-läsare, se figur~\ref{fig:rfid}. Vi använder oss av Par\-all\-ax-Read\-er\footnote{Datablad för Par\-all\-ax-Read\-er\, \url{https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/rfid-reader-v21.pdf}, hämtad 2014-05-23}. 
RFID-läsaren använder sig av serieprotokollet asynkron USART för att skicka data från RFID-korten vidare till CPU:n. Pinne 23 som RFID-läsaren är inkopplad på har stöd för seriell kommunikation och konfigureras för att matcha dataöverföringshastigheten från läsaren.

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.6\linewidth]{bilder/robotbilder/Rfid.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Par\-all\-ax-Read\-er} %figurtext.
  \label{fig:rfid}
\end{figure}

Då brus kan ge upphov till en falsk RFID-läsning, så kontrolleras att mottaget data matchar vissa symboler. Vi har valt att leta efter en start byte, 0x0A, som indikerar början på en RFID-taggs unika ID. För att ytterligare säkerställa en korrekt läsning görs denna kontroll två gånger innan kommandot för upptäckt brandhärd skickas till master.

\subsubsection{Reflexsensor}
Reflexsensorn, SFH300\footnote{Datablad för SFH300, \url{https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/sfh300.pdf}, hämtad 2014-05-23}, används för att beräkna avlagd sträcka. Sensormodulen skickar ett kommando till styrmodulen då roboten åkt 40 cm, alltså då roboten kommit till ett nytt 40x40-segment. För att beräkna den avlagd sträckan fästs en pappersskiva på ett av robotens hjul. Skivan består av 6 vita och 6 svarta lika stora cirkelsektorer, vilket ses i figur~\ref{fig:reflex}. Reflexsensorn detekterar varje gång skivan byter färg och på så sätt kan den avlagda sträckan räknas ut.

\subsubsection{Avståndssensorer}
Roboten har fem stycken av\-stånds\-sensorer varav en är för mellandistans, GP2Y0A02YK 20-150 cm\footnote{Datablad för GP2Y0A02YK, \url{https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/gp2y0a02_e.pdf}, hämtad 2014-05-23}, och resterande 4 är för \hyphenation{kortdistans},GP\-2Y\-0A\-21\-YK 10-80 cm\footnote{Datablad för GP\-2Y\-0A\-21\-YK, \url{https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/gp2y0a21.pdf}, hämtad 2014-05-23}. Mellandistanssensorn är placerad på robotens vänstra sida riktad utåt, två av kortdistanssensorerna är placerade på robotens högra sida, en är placerad fram på roboten och den sista är placerad på robotens baksida.

PIN 1 på kortdistanssensorerna och medeldistanssensorn kopplas till port A PIN 35 till 38 respektive PIN 34 på processorn. Sensorerna skickar alltså sin data, efter lågpassfiltrering, analogt till processorn för A/D-omvandling och omvandling till distans.

GND på sensorerna sätts till jord, Vcc och Vin sätts till hög.
 
Data från sensorerna används för att detektera väggar och skapa en kartabstraktion. Sensorerna på högersidan används för att reglera roboten under färd så att denna håller sig rak i förhållande till banans väggar och kan reglera avståndet från väggen.

För mer information om hur sensorer används för att bedöma avstånd se appendix D i kappan samt dokumentet \textit{''Sensorers applikation för kartritande robot''}\footnote{Ekelund, E. Habrman, D (2014), \textit{''Sensorers applikation för kartritande robot''}}.

\subsubsection{Vinkelhastighetssensor (gyro)}
För att underlätta beräkningar av körriktningar och hålla koll på hur mycket roboten roterat används en vinkelhastighetssensor även kallat gyro, MLX\-90\-609\footnote{Datablad för MLX\-90\-609, \url{https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/MLX90609\_datasheet.pdf}. hämtad 2014-05-23}. OUTAR på gyron, PIN 24, kopplas till ett LP-filter för att minska brus och den filtrerade signalen är kopplad till en PIN på sensormodulens A/D-omvandlare. Gyrot skickar en spänning mellan 0,5 V och 4,5 V där 2,5 V representerar en vinkelhastighet på noll grader per sekund. Sensormodulen börjar mäta på gyrot då ett specifikt kommando från styrmodulen mottagits. Sensormodulen skickar i sin tur tillbaka ett kommando då roboten roterat 90 grader. Sensormodulen låser sig till endast mätningar på gyroskopet under svängar för att öka noggrannheten.

Då roboten endast kommer att använda sig av vinkelräta svängar så räcker det att gyrot snabbt kan upptäcka då roboten roterat 90 grader. Om man adderar vinkelhastigheter med ett jämt tidsintervall så blir summan alltid lika stor vid 90 grader. Av denna anledning valdes det att inte involvera tiden mellan mätningar i summeringen, utan att istället skala om 90 grader till en konstant.
Gränserna som används för att registrera en rotation testades fram och kalibrerades genom att låta processorn summera alla värden från gyrot under en, för hand gjord, 90 graders rotation. Testet upprepades flertalet gånger, moturs och medurs, och medelvärdet av summorna som gavs användes som gräns för medurs- resp. motursrotation.

Då gyrot kan fluktuera lite kring 2,5 V även då roboten står still skulle detta kunna resultera i fel ifall rotationen inte startar direkt. För att lösa det problemet har ett 0,05 V brett band konstruerats kring 2,5 V där resultaten inte adderas till summan. 

För mer information om gyro se appendix i kappan.

\subsubsection{Övriga komponenter}
Övriga komponenter så som en reset-knapp och sex lågpassfilter kommer användas till denna modul.


% ----------------------------------- MJUKVARA ---------------------
% ------------------------------------------------------------------

\newpage
\section{PC-mjukvara}
Det grafiska gränssnittet är skrivet i Qt 5.3.0 och är designat i QtCreator. Mjukvaran är skriven för att vara kompatibel med MacOSX.

\subsection{Systemkrav}
\begin{itemize}
	\item Mac OS X 10.9 eller senare
	\item Xcode command line tools
	\item Ramverket Qt, version 5.3
\end{itemize}

\subsection{Bluetooth}
Bluetooth-mottagningen på PC fungerar genom att modulen i PC virtualiserar en seriellport som sedan data kan skickas på. För att skapa porten utnyttjas den inbyggda klassen i Qt, QSerialPort. Denna initialiserar Bluetooth-kopplingen och sätter inställningar som läs-skriv läge, BaudRate, antal databitar, paritet och stopbitar. Det är alltid exakt 27 bytes per transmission enligt specificerat protokoll, se figur~\ref{fig:bussprotocol}. 

Qt har händelsehantering. Qt kallar dessa händelser för slots och de kan liknas med avbrott.

\subsection{Läsning av Bluetooth}
När data kommer till Bluetooth-enheten skickas ett avbrott till huvudprogrammet och denna påbörjar mottagning i funktionen HandleReadyRead(). Denna funktion förklaras i flödesdiagrammet figur~\ref{fig:BTpc}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.6\linewidth]{bilder/bluetoothpc.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Flödesdiagram Bluetooth-mottagning} %figurtext.
  \label{fig:BTpc}
\end{figure}

\subsection{Skrivning till Bluetooth}
Skrivning till Bluetooth-enheten sker via den, i QSerialPort, inbyggda medlemsfunktionen write. I filen order.cpp finns en klass som sköter abstraktion mellan det grafiska användargränssnittet och QSerialPort. Denna har alla arrayer för kommandon specificerade i sig och skickar vidare data till serieportobjektet som sedan skriver denna data till Bluetooth-enheten. 

\subsection{Grafer för sensordata}
Med hjälp av klassen QCustomPlot kan vi skapa grafer för plottning av sensordata från roboten. När det grafiska användargränssnittet startar sätts en timer igång. Varje gång sensordata kommer till Bluetooth-enheten tidsstämplas denna och detta används för att rita tidsberoende sensorgrafer med historik. 
Dessa grafer kan sparas ned. Då skapas en ny mapp i användarens hemkatalog kallad MapMaster och i den en textfil. Med hjälp av ett menyval, Data->Review data, öppnas ett nytt fönster med interaktiva plottar som då kan analyseras.

\subsection{Styrkommandon}
Samtliga styrkommandon är slots och funktioner utförs när knappar i det grafiska användargränssnittet trycks på eller när motsvarande knapp på tangentbordet trycks in. 
Funktionerna för styrkommandon läser av hastighetsreglaget och skickar sedan styrkommandot till roboten. 
\subsection{Kartan}
Kartan använder sig av Qts inbyggda klass QGraphicsScene. Objekt med dimension 10x10 skapas och placeras ut för att tillsammans bilda kartan. 

% -----------------------------------FÖRBÄTTRINGAR---------------------------------------------
% ---------------------------------------------------------------------------------------------

\newpage
\section{Förslag på förbättringar av MapMaster2001}

Under projektets gång har vi upptäckt designval, både i hårdvara och mjukvara, som kunde lösts på andra sätt - och kunnat utföra dem både bättre och snabbare. Detta är naturligt i en arbetsprocess och ger oss lärdom för framtiden. I projektets slutfas har många tankar och funderingar på förbättringar diskuterats inom gruppen, nedan följer ett par av de mer utarbetade idéerna.

\subsection{Arkitektur \label{head:arch}}

Atmega 1284p-processorns begränsade beräkningskapacitet i kombination med det begränsade C++-stödet i kompilatorn AVR-GCC har kraftigt försvårat arbetet med kartabstraktion och utforskningsalgoritmer. Om man vill skapa avancerade algoritmer på relativt kort tid underlättar det om man kan utnyttja högnivåbibliotek, t ex STL från C++. Under projektets gång har vi bland annat implementerat en C++-klass på egen hand för att kunna skriva kartläggningsalgoritmer. 

Om vi skulle göra detta projekt igen skulle vi använda oss av en plattform som bygger på en ARM-processor och kan köra Debian GNU/Linux. Detta skulle dels ge oss tillgång till högnivåbibliotek, men också till threading och processorer med mer beräkningskraft, vilket skulle underlätta arbetet markant. 

För att fortfarande klara av kravet på tre processorer hos enheten kan man använda en Atmega 1284 som styrrelä och en för att kontrollera LCD-displayen, men alla tunga beräkningar skulle kunna utföras på ARM-processorn. 


\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,,width=0.5\linewidth]{bilder/Forslag_forbattring.png}  %skala och filnamn. 
  \end{center}
  \caption{MapMaster2001} %figurtext.
  \label{fig:arch}
\end{figure}

Den här systemarkitekturen skulle också minska belastningen på den egenimplementerade bussen, vilken vi haft problem med då vi lastar den hårt. 

\newpage
\subsection{Busskommunikation}
Busskommunikationen fungerade aldrig helt klanderfritt och skulle ha kunnat förbättrats. En bufferstruktur med flertalet pekare skulle ha kunnat nyttjas. Dessutom skulle en struktur där buss-mastern frågar slav-enheterna med jämna mellanrum om data istället för avbrott från slave-enheterna ha kunnat hjälpt implementeringens stabilitet, men däremot ökat responstiden för överföringen. 

\subsection{Sensorer}
Kortdistanssensorerna på robotens högra sida har en räckvidd på 10-80 cm. Då roboten vid reglering kan vara närmare väggen än 10 cm kan detta bli ett problem. Ett sätt att lösa problemet på är att byta sensorerna till sensorer med räckvidden 4-30 cm, 
GP2D120\footnote{Datablad för GP2D120, \url{https://docs.isy.liu.se/twiki/pub/VanHeden/DataSheets/gp2d120.pdf}, hämtad 2014-05-23}. Ett byte av sensorer skulle dock innebära större begränsningar vid kartläggning.
Sensorerna var först placerade längst ut på robotens högra sida och genom att flytta dem längre in på roboten lyckades vi öka marginalen för regleringen. Vi valde därför att inte byta ut sensorerna.

\subsection{Styralgoritmer}

Med en systemarkitektur likt den föreslagen i avsnitt~\ref{head:arch} skulle det förenkla implementering av avancerade vägfinnaralgoritmer. I projektets gång har vi utnyttjat en så kallad A-star-algoritm (A*), vilken fungerar i testmiljön med GNU Compiler Collection för Mac OS och Linux, som tyvärr ej fungerar med AVR-GCC och Atmegaprocessorn. 


% ---------------------------------------------------------------------------------------------

\newpage
\addcontentsline{toc}{section}{Referenser}

\listoffootnotes

% ----------------------------- Appendix -----------------------------------------
% --------------------------------------------------------------------------------

\newpage
\appendix
\pagestyle{empty}
\newgeometry{left=2cm,right=2cm,bottom=2cm,top=2cm}
\section*{Appendix A - Kopplingsscheman}
\addcontentsline{toc}{section}{Appendix A - Kopplingsscheman}
\subsection*{Kopplingsschema för kommunikationsmodul}

\begin{figure}[ht] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/Kom_uptodate.png}  %skala och filnamn. 
  \end{center}
  \caption{Kopplingsschema kommunikationsmodul} %figurtext.
  \label{fig:kopplingkom} %glöm inte att uppdatera era labels
\end{figure}
 \clearpage %flushes picture cache to place now
 

\subsection*{Kopplingsschema för styrmodul}

\begin{figure}[ht] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/kopplingsschema_styrmodul.png}  %skala och filnamn. 
  \end{center}
  \caption{Kopplingsschema styrmodul} %figurtext.
  \label{fig:kopplingstyr} %glöm inte att uppdatera era labels
\end{figure}
 \clearpage %flushes picture cache to place now
 

\subsection*{Kopplingsschema för sensormodul}

\begin{figure}[ht] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/sensormodulkoppling.png}  %skala och filnamn. 
  \end{center}
  \caption{Kopplingsschema sensormodul} %figurtext.
  \label{fig:kopplingsensor} %glöm inte att uppdatera era labels
\end{figure}
 \clearpage %flushes picture cache to place now
 

\newpage
\section*{Appendix B - Flödesscheman}
\addcontentsline{toc}{section}{Appendix B - Flödesscheman}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/SPIbild002.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Flödesdiagram för kommunikationfall 1.} %figurtext.
  \label{fig:case1flow}
\end{figure}

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=\linewidth]{bilder/SPIbild003.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Flödesdiagram för kommunikationfall 2.} %figurtext.
  \label{fig:case2flow}
\end{figure}
\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.9\linewidth]{bilder/SPIbild004.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Flödesdiagram för kommunikationfall 3.} %figurtext.
  \label{fig:case3flow}
\end{figure}
% \begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  % \begin{center}
  % \includegraphics[keepaspectratio=true,width=0.5\linewidth]{bilder/SPIbild005.jpg}  %skala och filnamn. 
  % \end{center}
  % \caption{Flödesdiagram för kommunikationfall 4.} %figurtext.
  % \label{fig:case4flow}
% \end{figure}
\clearpage %flushes picture cache to place now
\newpage

% ---------------------- ANVÄNDARMANUAL ---------------------------------------------------------
% ---------------------- ---------------------- ---------------------- ----------------------
\section*{Appendix C - Användarmanual}
\addcontentsline{toc}{section}{Appendix C - Avändarmanual}
Efter roboten har kopplats upp och programmerats med Atmel Studio kan roboten börja användas. 

Roboten kan köras i två lägen, antingen i manuellt eller autonomt läge. För att börja använda Mapmaster2001, slå på huvudströmbrytaren placerad på bakre delen av robotens chassi. Placera sedan roboten i dess startposition. 

Efter detta kan det vara god sed att trycka på de båda svarta knapparna på respektive virkort. Dessa är återställningsknappar och roboten är nu redo att kopplas upp till persondatorn. 

\subsection*{Bluetooth}
Aktivera Bluetooth via menyn i menyraden: 

\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=0.5\linewidth]{bilder/bluetooth.png}  %skala och filnamn. 
  \end{center}
  \caption{Bluetooth i OS X} %figurtext.
  \label{fig:bluetooth}
\end{figure}

Efter att du har startat upp din robot är det dags att ansluta roboten via Bluetooth till din persondator. Starta programmet mapGui.app för MapMaster och vänta på att du får kontakt med roboten. Att en länk har upprättats mellan dator och robot ser du lättast genom att kolla i programmet och se att programmets grafer börjar röra på sig. Får du sensordata, har du uppkoppling. 

\subsubsection*{Vid fel}
Om persondator och Bluetooth inte lyckas ansluta kan du först prova att starta om roboten och programvaran. Ifall detta inte löser problemen; dra ur den röda Bluetooth-enheten som sitter längst upp på roboten och sätt i den igen. 

\subsection*{Manuell körning}
I manuellt läge kan roboten enkelt manövreras med hjälp av piltangenterna på din dator.
\begin{itemize}
	\item Uppåt-pil - Roboten kör rakt fram.
	\item Nedåt-pil - Roboten kör rakt bak.
	\item Höger-pil - Roboten svänger 90 grader höger.
	\item Vänster-pil - Roboten svänger 90 grader vänster.
\end{itemize}
Orsaken till att roboten endast utför vinkelräta svängar är för att kartläggningen ska bli korrekt i manuellt läge. Utöver detta kan du även sätta vilken hastighet du vill att roboten ska köra i. Detta gör du i reglaget \emph{speed} i programvaran. Se figur 2. 
	
\subsection*{Autonom körning}
Om du vill växla roboten till att köra autonomt, placera då först roboten med baksidan 10 cm från en yttervägg av specificerat område. Banan måste bestå av 40x40 segment för att roboten ska kunna kartlägga korrekt, se appendix A i kravspecifikationen. För att starta autonom körning tryck CMD+X i programmet eller tryck på den grå knappen som är placerad på den översta virkortet på roboten. Roboten kommer då börja att åka och kartlägga banan. Allt eftersom roboten åker kommer du se hur kartan växer fram bit för bit i det vita rutnätet som syns i figur~\ref{fig:gui_man}. 

\subsubsection*{Felsökning}
Vid start av autonom körning är det viktigt att robotens moduler är korrekt initierade. Det kan därför vara bra, att efter huvudströmbrytaren är påslagen, återställa först mastermodulen och sedan styr- och sensormodul genom att trycka på respektive reset-knapp. Resetknapparna är svarta och sitter placerade på respektive virkort. Resetknapparna återställer endast den processor som är monterad på samma virkort som den knappen i fråga.

\subsection*{Övriga kommandon}
Utöver kommandon för manuell körning finns även
\begin{itemize}
	\item $Alt$+uppåt-pil - Öka hastigheten.
	\item $Alt$+nedåt-pil - Minska hastigheten.
	\item Mellanslag - Stanna roboten.
	\item $Cmd$+$s$ - Uppdatera parametrar med nya värden.
	\item $Cmd$+$x$ - Aktivera/avaktivera autonomt läge.
\end{itemize}
\newpage

\subsection*{Programvara}
Nedan följer en lista med tillhörande bild, figur~\ref{fig:gui_man} för att du som användare ska kunna få en överblick på alla kommadon som finns och hur du kör dem. 

\begin{enumerate}
	\item Robotens sensorvärden uppritat i realtid  
	\item Vid autonom körning så PD-reglerar roboten längs väggar. Här sätts konstanterna till regleringen.
	\item Denna knapp skickar nya PD-parametrar till roboten.
	\item Sparar undan data från sensor så man i efterhand kan plocka fram och granska det. 
	\item Upprättar Bluetooth kommunikation om det inte redan finns.
	\item Hämtar och uppdaterar kartan, bör endast utföras då roboten står still.
	\item Återställer Bluetooth om den har låst sig.
	\item Dra i reglaget för att ställa in robotens hastighet, fungerar ej i autonomt läge.
	\item Dessa värden används för att trimma in robotens förmåga att åka helt rakt fram. 
	\item Genom att klicka \emph{Data->review data} öppnas ett nytt fönster där den intresserade kan zooma i graferna och undersöka sensorvärdena närmare.  
\end{enumerate}	


\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=1\textwidth]{bilder/Gui_manual.png}  %skala och filnamn. 
  \end{center}
  \caption{GUI} %figurtext.
  \label{fig:gui_man} %glöm inte att uppdatera era labels
\end{figure}

% ------------------------- SENSORKOPPLING ------------------------ 

\newpage
\section*{Appendix D - Sensorkoppling \label{head:sensorkoppl}}

Vid uppkoppling av sensorer är det viktigt att dessa kopplas in i rätt sockel. 
Följ följande lista och figur \ref{fig:sensorkoppling} för att försäkra dig om att alla kontakter sitter rätt roterade samt i rätt sockel.

\begin{enumerate}
		\item Kortdistanssensor, Bak
		\item Kortdistanssensor, Höger bak
		\item Kortdistanssensor, Front
		\item Kortdistanssensor, Höger front
		\item Reflexsensor vid hjul
		\item Medeldistanssensor
		\item RFID-läsare
\end{enumerate}


\begin{figure}[htp] %Placera här om det finns plats, annars så snart som möjligt, på toppen av en sida.
  \begin{center}
  \includegraphics[keepaspectratio=true,width=1\textwidth]{bilder/Sensorkoppling.jpg}  %skala och filnamn. 
  \end{center}
  \caption{Illustration av sensorernas sockelplacering och kabelrotation} %figurtext.
  \label{fig:sensorkoppling} %glöm inte att uppdatera era labels
\end{figure}


\newpage
\section*{Appendix D - Utdrag ur programkod}
\addcontentsline{toc}{section}{Appendix D - Utdrag ur programkod}

\lstset{language=C++}
\lstinputlisting[language=C++]{../../Kod/Styr_m/Styr_m/Map.cpp}

\end{document}
